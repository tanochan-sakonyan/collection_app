# AGENTS.md

## プロジェクト概要

このリポジトリは、フロントエンドリポジトリです。主要ディレクトリは lib です。
packages には、flutter_link_sdk がクローンされています。触らないこと。
Android、iOS 関連のネイティブコードを触る際には、ios,android ディレクトリを使用します。

## セットアップ/ビルド/テスト

- 依存解決: `flutter pub get`
- Lint/Typecheck: `flutter analyze`
- テスト: テストは実装していません。
- 実装の最後に、静的エラーが出ていないことを確認すること。

## コーディング規約（要点）

- 追加した関数には、一言コメントアウトを付けること。
- コーディング後の、ターミナルでの説明は日本語で行うこと。

## ガードレール / 禁止事項

- 秘密情報を追加しない。生成コードに API キーを埋め込まない。

# 集金くん Ads について

このセクションは、「集金くん Ads（ベータ版）」の iOS 実装内容をまとめたものです。

---

## 機能の概要

「集金くん Ads」は、集金イベントが終わったタイミングで  
「2 件目にいかがですか？」というお店の提案を表示する機能です。

表示から 4 時間後には、「行きましたか？」というアンケートを表示します。  
位置情報を一度だけ取得し、近くのお店を紹介します。

---

## メインの動き

### 表示のきっかけ

- グループの人数が **10 人以上** の場合：未払いが **2 人以下** になったら表示
- グループの人数が **10 人以下** の場合：未払いが **0 人** になったら表示

上の条件を満たしたときに、近くのお店の情報を取得します。(BE に GET リクエストを送信する)

---

## お店の提案ポップアップ

### 表示の流れ

- 条件を満たしたら位置情報を取得する
- 位置情報をサーバー（BE）に送る
- サーバーからお店の情報を受け取る
- お店の情報をポップアップで表示する
- 最大 3 つまで同じポップアップ内にお店を表示する
- お店情報が返ってこなければ、何も表示しない

### 表示の回数と時間制限

- ポップアップを出した時刻を保存する
- その後 4 時間はポップアップを再表示しない
- ポップアップを出したイベントでは、ホーム画面に「Ads モジュール」を表示して再度見られるようにする
- Ads モジュールは 4 時間で自動的に消える

### デザイン

- 店舗名、コメント、距離（m）と徒歩分数、予約ボタンを表示
- 「予約する」ボタンを押すと外部ブラウザで開く
- 外側タップで閉じる
- お店が 0 件の場合は、何も表示しない

---

## アンケート

### 内容

ポップアップを表示してから 4 時間後に、  
「行きましたか？」というアンケートを表示します。
ここで情報を集めて、ビジネスコンテストでアピールします。

### 詳細

- ポップアップを出した時刻を保存しておく
- 4 時間後にアンケートを表示する
- 外をタップしても閉じられないようにする
- 「閉じる」ボタンを用意する
- 見た目は Ads ポップアップと似たデザインにする
- 回答後はサーバーに以下の情報を送る
  - イベント名（survey_name）
  - 行ったかどうか（has_gone：true / false）
  - 合計金額（total_money）

---

## 集金くん Ads を利用しない設定（オプトアウト）

### 内容

- メニュー（Drawer）に「集金くん Ads（ベータ版）を利用しない」というスイッチ(のようなもの)を追加する
- スイッチをオンにしたら、Ads ポップアップを表示しない
- すでに予約しているアンケートも通知を止める
- 状態は端末に保存して次回も引き継ぐ

---

## 位置情報の扱い

- iPhone の設定に表示される説明文を追加する  
  「近くのお店を提案するために一度だけ位置情報を使います」
- 位置情報は一度だけ取得し、バックグラウンドでは使わない
- 許可されなかった場合は「設定から許可してください」と案内する
- おおよその位置でも動作するようにする
- 距離は「約 ◯m」のように目安で表示する

---

## プライバシーポリシー

### 変更点

- 位置情報を「近くのお店を提案するためだけ」に使うことを明記する
- 他の目的では使わないことを明記する
- この機能は任意であり、利用しない設定があることを明記する

### 同意の方法

- アプリ起動時に「プライバシーポリシーを変更しました」というお知らせを出す
- 「OK」を押したら同意したものとみなす
- 既存の実装があるため、それを参考にしてください。

---

## サーバーとのやりとり

### Stores(BE の DB で実装)

- id:
- latitude:
- longitude:
- name: 居酒屋いけお(String)
- comment: ゆっくり過ごせます。個室完備！(String)
- link:aaaaaaa(String、短縮されてないやつ。)
- phone_num: "080-aaaa-aaaa"(String?)
- created_at:

### Surveys(BE の DB で実装)

- id:
- survey_name: (String)
- has_gone: bool
- people_num: 10(int)
- total_money: 30000(int)
- created_at:

## API

### GET stores

ユーザーの位置情報を FE から送る
BE は、近くのお店 1 個を返す
エンドポイント
`/ads/stores`
リクエスト

```JSON
- latitude:31.2222222(String)
- longitude: 146.444444444(String)
```

レスポンス

```JSON
- name: 居酒屋いけお(String)
- comment: ゆっくり過ごせます。個室完備！(String)
- link: aaaaaa(String)
- distance_m: 800(int)
- time_min: 5(int)
```

### 短縮 URL のリダイレクト用

BE が実装

### POST ads survey

/ads/survey
リクエスト

```JSON
- survey_name: (String)
- has_gone: bool
- total_money: 30000(int)
```

レスポンス

```
なんも返ってこんで良い
```
